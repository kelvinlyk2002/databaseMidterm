<script src="/js/jquery-3.6.0.min.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>
<script src="/js/d3.v6.js"></script>
<!-- Make sure you put this AFTER Leaflet's CSS -->
<script>
  function drawChoropleth(startYearMonth, EndYearMonth, boroughName = ''){
        // The svg
        const svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

        // Map and projection
        const path = d3.geoPath();
        const projection = d3.geoMercator()
        .scale(<%= scaleRatio %>)
        .center(<%- JSON.stringify(centreLongLat) %>)
        .translate([width / 2, height / 2]);

        // Data and color scale
        let data = new Map()

        // Load external data and boot
        Promise.all([
        d3.json(`/londonGEO/${boroughName}`),
        d3.json(`/enquireCrime/${startYearMonth}/${EndYearMonth}/${boroughName}`)
        ]).then(function(loadData){
          let topo = loadData[0];
          let crimeCountRows = loadData[1]['data'];
          for(var i = 0; i<crimeCountRows.length; i++){
            data.set(crimeCountRows[i].wardCode, crimeCountRows[i].crimeCount);
          }
          const colorScale = d3.scaleThreshold()
          .domain(loadData[1]['scales'])
          .range(d3.schemeBlues[loadData[1]['scales'].length + 1]);

          // Draw the map
          svg.append("g")
            .selectAll("path")
            .data(topo.features)
            .join("path")
            // draw each wards
            .attr("d", d3.geoPath()
              .projection(projection)
            )
            // set the color of each country
            .attr("fill", function (d) {
                  d.total = data.get(d.properties.WD21CD) || 0;
              return colorScale(d.total);
            })
        })
  }
  drawChoropleth('202004', '202203', '<%= borough %>');
  
</script>